import {useEffect, useContext} from 'react'
import useFetch from 'hooks/useFetch'
import {CurrentUserContext} from 'context/currentUser'
import useLocalStorage from 'hooks/useLocalStorage'

const CurrentUserChecker = ({children}) => {
	const [{response}, doFetch] = useFetch('/user')
	const [CurrentUserState, setCurrentUserState] = useContext(CurrentUserContext)
	const [token] = useLocalStorage('token') //проверяю useLocalStorage есть токент или нет

	useEffect(() => { 
		if (!token) {
			setCurrentUserState(state => ({
			...state,
			isLoggedIn: false 
		}))
			return 
		}

		doFetch()
		setCurrentUserState(state => ({
			...state,
			isLoading: true
		}))
	}, [token, setCurrentUserState])

	useEffect(() => {
		if (!response) { 
			return
		}

		setCurrentUserState(state => ({
			...state, 
			isLoggedIn: true,
			isLoading: false,
			currentUser: response.user
		}))
	}, [response, setCurrentUserState])

	return children
}

export default CurrentUserChecker
